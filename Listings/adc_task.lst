C51 COMPILER V9.54   ADC_TASK                                                              04/30/2017 13:50:23 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE ADC_TASK
OBJECT MODULE PLACED IN .\Objects\adc_task.obj
COMPILER INVOKED BY: D:\Keil_v5\C51\BIN\C51.EXE task\adc\adc_task.c OMF2 OPTIMIZE(8,SPEED) BROWSE DEBUG PRINT(.\Listings
                    -\adc_task.lst) OBJECT(.\Objects\adc_task.obj)

line level    source

   1          #include "task/adc/adc_task.h"
   2          
   3          /* AD sample */
   4          extern  data  Byte         ad_equ_pum;                  //Ã¿¸öÍ¨µÀ²ÉÑù¶à´ÎÇóÆ½¾ùÖµ
   5          
   6          extern  data  Byte         ad_index;                    //ÕýÔÚ²ÉÑùµÄÍ¨µÀºÅ, È¡Öµ·¶Î§0~1
   7          extern  data  sAD_Sample   ad_sample;                   //±£´æµ±Ç°²ÉÑùÖµ
   8          extern  data  sAD_Sum      ad_samp_equ[2];              //¾ùºâÈ¥ÔëÉùÇóºÍ
   9          extern  data  Uint16       ad_chn_sample[2];            //×îÐÂÒ»ÂÖ²ÉÑùÖµ£¨ÒÑ¾ùºâÈ¥ÔëÉù£¬Ã¿Í¨µÀÒ»¸öµã£©
  10          extern  data  Byte         ad_chn_over[2];              //¸÷Í¨µÀÁ¬Ðø²ÉÑùµã(¾ùºâºó)µÄ·§ÖµÅÐ¶¨£º 0 - ·¶Î§ÄÚ£
             -» 1 - ³¬·§Öµ
  11          extern  data  Byte         ad_alarm_exts;               //±¨¾¯±êÖ¾£º00-ÎÞ±¨¾¯,01-1#·ÀÇø±¨¾¯£¬02-2#·ÀÇø±¨¾¯
             -£¬03-1#·ÀÇøºÍ2#·ÀÇøÍ¬Ê±±¨¾¯
  12          extern  data  Uint16       ad_alarm_tick[2];            //¸÷Í¨µÀ±¨¾¯¼ÆÊ±tick
  13          
  14          void adc_task_init(void)
  15          {
  16   1              Byte i;
  17   1      
  18   1              //Ïà¹Ø±äÁ¿³õÊ¼»¯
  19   1              ad_index        = 0;
  20   1              ad_sample.valid = 0;                     //¿ÕÏÐ£¬¿ÉÒÔÐ´ÈëÐÂÖµ
  21   1              
  22   1              ad_alarm_exts = 0;
  23   1              
  24   1              for (i = 0; i < 2; i++) {
  25   2                      ad_samp_equ[i].sum       = 0;        //¾ùºâÈ¥ÔëÉùÇóºÍ
  26   2                      ad_samp_equ[i].point     = 0;
  27   2                      ad_chn_sample[i]         = 0;        //×îÐÂÒ»ÂÖ²ÉÑùÖµ
  28   2                      ad_chn_over[i]           = 0;        //¸÷Í¨µÀÁ¬Ðø²ÉÑùµã(¾ùºâºó)µÄ·§ÖµÅÐ¶¨£º¾ùÔÚ·¶Î§ÄÚ
  29   2                      ad_alarm_tick[i]         = 0;
  30   2              }
  31   1          
  32   1              //adcÓ²¼þ³õÊ¼»¯
  33   1              adc_init();
  34   1      }
  35          
  36          void adc_task(void)
  37          {
  38   1              Byte    index;          //²ÉÑùÍ¨µÀºÅ
  39   1              Uint16  val_temp;       //ÐÂËÍÈëµÄ10bit²ÉÑùÖµ,  ºó×÷ÁÙÊ±±äÁ¿
  40   1              Uint16  val;            //4µã¾ùºâºóµÃµ½µÄÆ½¾ù²ÉÑùÖµ, ×÷ÎªÒ»¸ö¿É½øÐÐ³¬ÏÞÅÐ¶ÏµÄ×îÐ¡µã
  41   1      
  42   1              //ÓÐÐÂ²ÉÑùÊý¾Ýµ½´ï
  43   1              if (ad_sample.valid) {  
  44   2                      // 0. ±£´æµ½ÁÙÊ±±äÁ¿
  45   2                      val_temp = ad_sample.val;
  46   2                      index    = ad_sample.index;
  47   2      
  48   2                      // 1. ±£´æµ½¾ùºâÈ¥ÔëÉùÇóºÍÖÐ
  49   2                      ad_samp_equ[index].sum += val_temp;
  50   2                      ad_samp_equ[index].point++;
  51   2      
  52   2                      // 2. µ±Ç°Í¨µÀÊÇ·ñÂú×ãÈ¥ÔëÉùµãÊý
C51 COMPILER V9.54   ADC_TASK                                                              04/30/2017 13:50:23 PAGE 2   

  53   2                      if (ad_samp_equ[index].point == 4) {
  54   3                              // ÒÑÂúÈ¥ÔëÉùµãÊý£¬¿ÉÇó³ö¾ùºâºóµÄÒ»¸öµã
  55   3                              // 2.a Çó³ö¶ÔÓ¦Í¨µÀµÄÒ»¸ö²ÉÑùµã
  56   3                              val = ad_samp_equ[index].sum / 4;  //ÇóÆ½¾ùÖµ
  57   3      
  58   3                              // 2.b ÇåÁãµ±Ç°Í¨µÀµÄÈ¥ÔëÉùÇóºÍ½á¹¹
  59   3                              ad_samp_equ[index].sum = 0;
  60   3                              ad_samp_equ[index].point = 0;
  61   3      
  62   3                              // 2.c ±£´æÊµÊ±²ÉÑùÖµ
  63   3                              ad_chn_sample[index] = val;   //±£´æµ½×îÐÂÒ»ÂÖ²ÉÑùÖµÊý×éÖÐ
  64   3                              
  65   3                              // 2.d ÅÐ¶Ïµ±Ç°Í¨µÀÊÇ·ñ±¨¾¯
  66   3                              ad_chn_over[index] = ad_chn_over[index] << 1;   //Bit0Ìî0£¬Òò´ËÈ±Ê¡ÔÚÔÊÐí·¶Î§ÄÚ
  67   3                              
  68   3                              if (index == 0) {//1#·ÀÇø
  69   4                                      //a. ÊÇ·ñ³¬ÉÏÏÂÏÞ·§Öµ
  70   4                                      if (!(((val >= TH_A1_EOL_MIN) && (val <= TH_A1_EOL_MAX)) || 
  71   4                                                 ((val >= TH_A1_NC_MIN)  && (val <= TH_A1_NC_MAX)))) { 
  72   5                                              //±¨¾¯
  73   5                                              ad_chn_over[index] |= 0x01;       
  74   5                                      }
  75   4                              } else if (index == 1) {//2#·ÀÇø
  76   4                                      //a. ÊÇ·ñ³¬ÉÏÏÂÏÞ·§Öµ
  77   4                                      if (val >= TH_A2_MAX) { 
  78   5                                              //±¨¾¯
  79   5                                              ad_chn_over[index] |= 0x01;       
  80   5                                      }
  81   4                              }
  82   3                              
  83   3                              //Á¬Ðø4µã³¬·¶Î§£¬´ËÍ¨µÀÓÐ±¨¾¯
  84   3                              if ((ad_chn_over[index] & 0x0F) == 0x0F) {
  85   4                                      //³¬³öÔÊÐí·¶Î§£¬ÖÃ±êÖ¾
  86   4                                      ad_alarm_exts |= (1 << index);
  87   4      
  88   4                                      //±¨¾¯¼ÆÊ±tick
  89   4                                      ad_alarm_tick[index] = ALARM_TEMPO;                     
  90   4                              } else if ((ad_chn_over[index] & 0x0F) == 0x00) {//ÎÞ±¨¾¯
  91   4                                      if (ad_alarm_tick[index] == 0) {//¼ì²é±¨¾¯Ê±¼äÊÇ·ñÒÑµ½
  92   5                                              //±¨¾¯ÒÑ¾­µ½×î´ó±¨¾¯Ê±¼ä, Í£Ö¹±¨¾¯
  93   5                                              ad_alarm_exts &= ~(1 << index);
  94   5                                      }
  95   4                              }
  96   3                      }
  97   2      
  98   2                      //3.µ±Ç°²ÉÑùÖµ´¦ÀíÍê±Ï£¬ÔÊÐíÐÂµÄ²ÉÑùÖµÊäÈë
  99   2                      ad_sample.valid = FALSE;
 100   2              }
 101   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    306    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
C51 COMPILER V9.54   ADC_TASK                                                              04/30/2017 13:50:23 PAGE 3   

   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
